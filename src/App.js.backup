import { useState } from 'react';
import './App.css';

function App() {
  // Tab state
  const [activeTab, setActiveTab] = useState('image');
  
  // API Key state
  const [apiKey, setApiKey] = useState(localStorage.getItem('krea_api_key') || '');
  const [showApiKeyInput, setShowApiKeyInput] = useState(false);

  // Image generation state
  const [prompt, setPrompt] = useState('Deep-sea city with merfolk and submerged ruins, channeling underwater fantasy anime.');
  const [batchSize, setBatchSize] = useState(1);
  const [numImages, setNumImages] = useState(1);
  const [resolution, setResolution] = useState('1K');
  const [loading, setLoading] = useState(false);
  const [jobId, setJobId] = useState(null);
  const [status, setStatus] = useState('');
  const [imageUrl, setImageUrl] = useState(null);
  const [error, setError] = useState(null);

  // Video generation state
  const [videoPrompt, setVideoPrompt] = useState('A tranquil bay with colorful fishing boats anchored, their reflections mirrored in the still water.');
  const [videoModel, setVideoModel] = useState('seedance-1.0-pro-fast');
  const [aspectRatio, setAspectRatio] = useState('16:9');
  const [duration, setDuration] = useState(5);
  const [videoResolution, setVideoResolution] = useState('720p');
  const [videoLoading, setVideoLoading] = useState(false);
  const [videoJobId, setVideoJobId] = useState(null);
  const [videoStatus, setVideoStatus] = useState('');
  const [videoUrl, setVideoUrl] = useState(null);
  const [videoError, setVideoError] = useState(null);

  // Video models configuration
  const videoModels = {
    'seedance-1.0-pro-fast': {
      name: 'Seedance 1.0 Pro Fast',
      provider: 'bytedance',
      endpoint: 'bytedance/seedance-1.0-pro-fast'
    },
    'kling-2.5': {
      name: 'Kling 2.5',
      provider: 'kling',
      endpoint: 'kling/kling-2.5'
    }
  };

  const API_TOKEN = apiKey || process.env.REACT_APP_KREA_API_TOKEN;

  const saveApiKey = () => {
    localStorage.setItem('krea_api_key', apiKey);
    setShowApiKeyInput(false);
    alert('API Key guardada exitosamente!');
  };

  const clearApiKey = () => {
    setApiKey('');
    localStorage.removeItem('krea_api_key');
    alert('API Key eliminada');
  };

  const generateImage = async () => {
    if (!API_TOKEN || API_TOKEN === 'your_token_here') {
      setError('Por favor, ingresa tu API token de Krea AI');
      setShowApiKeyInput(true);
      return;
    }

    setLoading(true);
    setError(null);
    setImageUrl(null);
    setStatus('Generating...');

    try {
      const options = {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prompt: prompt,
          batchSize: batchSize,
          numImages: numImages,
          resolution: resolution
        })
      };

      const response = await fetch('https://api.krea.ai/generate/image/google/nano-banana', options);
      const data = await response.json();

      if (data.job_id) {
        setJobId(data.job_id);
        setStatus(`Job created: ${data.status}`);
        pollJobStatus(data.job_id);
      } else {
        throw new Error('Failed to create job');
      }
    } catch (err) {
      setError(`Error: ${err.message}`);
      setLoading(false);
    }
  };

  const pollJobStatus = async (id) => {
    const maxAttempts = 60; // Poll for up to 5 minutes (60 * 5 seconds)
    let attempts = 0;

    const checkStatus = async () => {
      try {
        const options = {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`
          }
        };

        const response = await fetch(`https://api.krea.ai/jobs/${id}`, options);
        const data = await response.json();

        setStatus(`Status: ${data.status}`);

        if (data.status === 'completed') {
          if (data.result && data.result.urls && data.result.urls.length > 0) {
            setImageUrl(data.result.urls[0]);
            setStatus('Completed!');
          } else {
            setError('Job completed but no image URL found');
          }
          setLoading(false);
        } else if (data.status === 'failed') {
          setError('Job failed');
          setLoading(false);
        } else {
          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(checkStatus, 5000); // Poll every 5 seconds
          } else {
            setError('Timeout: Job took too long to complete');
            setLoading(false);
          }
        }
      } catch (err) {
        setError(`Error checking status: ${err.message}`);
        setLoading(false);
      }
    };

    checkStatus();
  };

  const generateVideo = async () => {
    if (!API_TOKEN || API_TOKEN === 'your_token_here') {
      setVideoError('Por favor, ingresa tu API token de Krea AI');
      setShowApiKeyInput(true);
      return;
    }

    setVideoLoading(true);
    setVideoError(null);
    setVideoUrl(null);
    setVideoStatus('Generating video...');

    try {
      const selectedModel = videoModels[videoModel];
      const options = {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prompt: videoPrompt,
          aspectRatio: aspectRatio,
          duration: duration,
          resolution: videoResolution
        })
      };

      const response = await fetch(`https://api.krea.ai/generate/video/${selectedModel.endpoint}`, options);
      const data = await response.json();

      if (data.job_id) {
        setVideoJobId(data.job_id);
        setVideoStatus(`Job created: ${data.status}`);
        pollVideoJobStatus(data.job_id);
      } else {
        throw new Error('Failed to create video job');
      }
    } catch (err) {
      setVideoError(`Error: ${err.message}`);
      setVideoLoading(false);
    }
  };

  const pollVideoJobStatus = async (id) => {
    const maxAttempts = 120; // Poll for up to 10 minutes (videos take longer)
    let attempts = 0;

    const checkStatus = async () => {
      try {
        const options = {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`
          }
        };

        const response = await fetch(`https://api.krea.ai/jobs/${id}`, options);
        const data = await response.json();

        setVideoStatus(`Status: ${data.status}`);

        if (data.status === 'completed') {
          if (data.result && data.result.urls && data.result.urls.length > 0) {
            setVideoUrl(data.result.urls[0]);
            setVideoStatus('Video completed!');
          } else {
            setVideoError('Job completed but no video URL found');
          }
          setVideoLoading(false);
        } else if (data.status === 'failed') {
          setVideoError('Video generation failed');
          setVideoLoading(false);
        } else {
          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(checkStatus, 5000); // Poll every 5 seconds
          } else {
            setVideoError('Timeout: Video generation took too long to complete');
            setVideoLoading(false);
          }
        }
      } catch (err) {
        setVideoError(`Error checking status: ${err.message}`);
        setVideoLoading(false);
      }
    };

    checkStatus();
  };

  return (
    <div className="App">
      <div className="container">
        <h1>Krea AI Generator</h1>
        
        {/* API Key Section */}
        <div className="api-key-section">
          <button 
            className="api-key-toggle"
            onClick={() => setShowApiKeyInput(!showApiKeyInput)}
          >
            {showApiKeyInput ? 'Hide API Key' : 'Config API Key'}
          </button>
          
          {showApiKeyInput && (
            <div className="api-key-form">
              <div className="form-group">
                <label htmlFor="apiKey">API Key, Krea AI:</label>
                <div className="api-key-input-group">
                  <input
                    type="password"
                    id="apiKey"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="Enter your API key here..."
                    className="api-key-input"
                  />
                  <button onClick={saveApiKey} className="save-button" disabled={!apiKey}>
                    Save
                  </button>
                  {apiKey && (
                    <button onClick={clearApiKey} className="clear-button">
                      Clear
                    </button>
                  )}
                </div>
                <p className="api-key-hint">
                  {apiKey ? '‚úÖ API Key Saved' : '‚ö†Ô∏è No API Key configured'}
                  {apiKey && ' (saved in localStorage)'}
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Tabs */}
        <div className="tabs">
          <button 
            className={`tab ${activeTab === 'image' ? 'active' : ''}`}
            onClick={() => setActiveTab('image')}
          >
            Image Generation
          </button>
          <button 
            className={`tab ${activeTab === 'video' ? 'active' : ''}`}
            onClick={() => setActiveTab('video')}
          >
            Video Generation
          </button>
        </div>

        {/* Image Generation Tab */}
        {activeTab === 'image' && (
          <div className="tab-content">
            <div className="form-group">
              <label htmlFor="prompt">Prompt:</label>
              <textarea
                id="prompt"
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                placeholder="Describe the image you want to generate..."
                rows="4"
                disabled={loading}
              />
            </div>

            <div className="settings-row">
              <div className="form-group">
                <label htmlFor="batchSize">Batch Size:</label>
                <input
                  type="number"
                  id="batchSize"
                  value={batchSize}
                  onChange={(e) => setBatchSize(parseInt(e.target.value))}
                  min="1"
                  max="10"
                  disabled={loading}
                />
              </div>

              <div className="form-group">
                <label htmlFor="numImages">Number of Images:</label>
                <input
                  type="number"
                  id="numImages"
                  value={numImages}
                  onChange={(e) => setNumImages(parseInt(e.target.value))}
                  min="1"
                  max="10"
                  disabled={loading}
                />
              </div>

              <div className="form-group">
                <label htmlFor="resolution">Resolution:</label>
                <select
                  id="resolution"
                  value={resolution}
                  onChange={(e) => setResolution(e.target.value)}
                  disabled={loading}
                >
                  <option value="1K">1K</option>
                  <option value="2K">2K</option>
                  <option value="4K">4K</option>
                </select>
              </div>
            </div>

            <button 
              onClick={generateImage} 
              disabled={loading || !prompt}
              className="generate-button"
            >
              {loading ? 'Generating...' : 'Generate Image'}
            </button>

            {status && (
              <div className="status-message">
                <p>{status}</p>
                {jobId && <p className="job-id">Job ID: {jobId}</p>}
              </div>
            )}

            {error && (
              <div className="error-message">
                <p>{error}</p>
              </div>
            )}

            {loading && (
              <div className="loading-spinner">
                <div className="spinner"></div>
              </div>
            )}

            {imageUrl && (
              <div className="image-container">
                <h2>Generated Image</h2>
                <img src={imageUrl} alt="Generated by Krea AI" />
                <a href={imageUrl} target="_blank" rel="noopener noreferrer" className="download-link">
                  Open Full Size
                </a>
              </div>
            )}
          </div>
        )}

        {/* Video Generation Tab */}
        {activeTab === 'video' && (
          <div className="tab-content">
            <div className="form-group">
              <label htmlFor="videoPrompt">Prompt:</label>
              <textarea
                id="videoPrompt"
                value={videoPrompt}
                onChange={(e) => setVideoPrompt(e.target.value)}
                placeholder="Describe the video you want to generate..."
                rows="4"
                disabled={videoLoading}
              />
            </div>

            {/* Model Selector - Highlighted Section */}
            <div className="form-group model-selector-container">
              <label htmlFor="videoModel">üé¨ Video Model:</label>
              <select
                id="videoModel"
                value={videoModel}
                onChange={(e) => setVideoModel(e.target.value)}
                disabled={videoLoading}
                className="model-selector"
              >
                {Object.entries(videoModels).map(([key, model]) => (
                  <option key={key} value={key}>
                    {model.name} ({model.provider})
                  </option>
                ))}
              </select>
              <p className="model-info">
                {videoModels[videoModel].name} - Provider: {videoModels[videoModel].provider}
              </p>
            </div>

            <div className="settings-row">
              <div className="form-group">
                <label htmlFor="aspectRatio">Aspect Ratio:</label>
                <select
                  id="aspectRatio"
                  value={aspectRatio}
                  onChange={(e) => setAspectRatio(e.target.value)}
                  disabled={videoLoading}
                >
                  <option value="16:9">16:9</option>
                  <option value="9:16">9:16</option>
                  <option value="1:1">1:1</option>
                  <option value="4:3">4:3</option>
                </select>
              </div>

              <div className="form-group">
                <label htmlFor="duration">Duration (seconds):</label>
                <input
                  type="number"
                  id="duration"
                  value={duration}
                  onChange={(e) => setDuration(parseInt(e.target.value))}
                  min="1"
                  max="10"
                  disabled={videoLoading}
                />
              </div>

              <div className="form-group">
                <label htmlFor="videoResolution">Resolution:</label>
                <select
                  id="videoResolution"
                  value={videoResolution}
                  onChange={(e) => setVideoResolution(e.target.value)}
                  disabled={videoLoading}
                >
                  <option value="720p">720p</option>
                  <option value="1080p">1080p</option>
                </select>
              </div>
            </div>

            <button 
              onClick={generateVideo} 
              disabled={videoLoading || !videoPrompt}
              className="generate-button"
            >
              {videoLoading ? 'Generating Video...' : 'Generate Video'}
            </button>

            {videoStatus && (
              <div className="status-message">
                <p>{videoStatus}</p>
                {videoJobId && <p className="job-id">Job ID: {videoJobId}</p>}
              </div>
            )}

            {videoError && (
              <div className="error-message">
                <p>{videoError}</p>
              </div>
            )}

            {videoLoading && (
              <div className="loading-spinner">
                <div className="spinner"></div>
                <p className="loading-text">Video generation may take a few minutes...</p>
              </div>
            )}

            {videoUrl && (
              <div className="video-container">
                <h2>Generated Video</h2>
                <video controls src={videoUrl} className="generated-video">
                  Your browser does not support the video tag.
                </video>
                <a href={videoUrl} target="_blank" rel="noopener noreferrer" className="download-link">
                  Open Full Size
                </a>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

export default App;
